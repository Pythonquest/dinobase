name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  lint-dbt:
    name: Lint dbt
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./dbt/pbdb_dbt
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dbt-bigquery
        run: |
          pip install dbt-bigquery
      
      - name: Create dbt profiles
        run: |
          mkdir -p ~/.dbt
          cat > ~/.dbt/profiles.yml << 'EOF'
          pbdb_dbt:
            target: ci
            outputs:
              ci:
                type: bigquery
                method: oauth
                project: "${{ secrets.GCP_PROJECT_ID }}"
                dataset: pbdb_analytics
                threads: 1
                timeout_seconds: 300
                location: US
          EOF
      
      - name: Run dbt parse
        run: |
          dbt parse
        env:
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}

  lint-python:
    name: Lint Python
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./ingest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install flake8 black
      
      - name: Run flake8
        run: |
          flake8 pbdb_fetch.py --max-line-length=100 --exclude=venv,env
        continue-on-error: true
      
      - name: Check formatting with black
        run: |
          black --check pbdb_fetch.py
        continue-on-error: true

  test-dbt:
    name: Test dbt
    runs-on: ubuntu-latest
    needs: lint-dbt
    if: ${{ secrets.GCP_SA_KEY != '' }}
    defaults:
      run:
        working-directory: ./dbt/pbdb_dbt
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dbt-bigquery
        run: |
          pip install dbt-bigquery
      
      - name: Create dbt profiles
        run: |
          mkdir -p ~/.dbt
          cat > ~/.dbt/profiles.yml << 'EOF'
          pbdb_dbt:
            target: ci
            outputs:
              ci:
                type: bigquery
                method: oauth
                project: "${{ secrets.GCP_PROJECT_ID }}"
                dataset: pbdb_analytics
                threads: 1
                timeout_seconds: 300
                location: US
          EOF
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      
      - name: Run dbt tests
        run: |
          dbt test
        env:
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
        continue-on-error: true
